name: ğŸ“Š Work 2027 Metrics Dashboard

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM
  workflow_dispatch:
  push:
    paths:
      - '**/Work2027*.md'
      - '**/Work2027*.ps1'
      - '**/Work2027*.zip'

jobs:
  generate-metrics:
    name: ğŸ“ˆ Generate Weekly Metrics
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“Š Calculate Work 2027 ROI
      id: metrics
      run: |
        python << 'EOF'
        import os
        import json
        from datetime import datetime

        # Calculate comprehensive metrics
        work2027_files = []
        total_size = 0

        for root, dirs, files in os.walk('.'):
            for file in files:
                if 'Work2027' in file or 'work2027' in file.lower():
                    filepath = os.path.join(root, file)
                    try:
                        size = os.path.getsize(filepath)
                        total_size += size
                        work2027_files.append({
                            'name': file,
                            'path': filepath,
                            'size': size,
                            'type': file.split('.')[-1] if '.' in file else 'unknown'
                        })
                    except:
                        pass

        # Categorize files
        categories = {
            'executive': len([f for f in work2027_files if any(term in f['name'].lower() for term in ['executive', 'powerpoint', 'word'])]),
            'implementation': len([f for f in work2027_files if any(term in f['name'].lower() for term in ['implementation', 'checklist', 'guide'])]),
            'automation': len([f for f in work2027_files if any(term in f['name'].lower() for term in ['autoinstaller', 'setup', 'voice'])]),
            'documentation': len([f for f in work2027_files if f['type'] == 'md']),
            'packages': len([f for f in work2027_files if f['type'] == 'zip']),
            'configs': len([f for f in work2027_files if any(term in f['name'].lower() for term in ['config', 'vscode'])])
        }

        # Calculate productivity metrics
        base_productivity = 100
        copilot_boost = categories['automation'] * 50  # 50% per automation file
        documentation_boost = categories['documentation'] * 25  # 25% per doc
        executive_boost = categories['executive'] * 40  # 40% per executive doc

        total_productivity = base_productivity + copilot_boost + documentation_boost + executive_boost
        roi_percentage = ((total_productivity - base_productivity) / base_productivity) * 100

        # Calculate financial impact
        hourly_rate = 25  # USD per hour
        hours_saved_daily = 6  # Conservative estimate
        working_days = 250
        annual_savings = hourly_rate * hours_saved_daily * working_days

        metrics = {
            'timestamp': datetime.now().isoformat(),
            'file_analysis': {
                'total_files': len(work2027_files),
                'total_size_mb': round(total_size / (1024*1024), 2),
                'categories': categories
            },
            'productivity_metrics': {
                'base_score': base_productivity,
                'enhanced_score': total_productivity,
                'improvement_percentage': round(roi_percentage, 1),
                'productivity_multiplier': round(total_productivity / base_productivity, 2)
            },
            'financial_impact': {
                'hourly_rate_usd': hourly_rate,
                'hours_saved_daily': hours_saved_daily,
                'working_days_annual': working_days,
                'annual_savings_usd': annual_savings,
                'roi_percentage': round((annual_savings / 2400) * 100, 0)  # Assuming $2400 setup cost
            },
            'quality_indicators': {
                'documentation_completeness': min(100, categories['documentation'] * 12),
                'automation_coverage': min(100, categories['automation'] * 20),
                'executive_readiness': min(100, categories['executive'] * 30),
                'overall_maturity': min(100, (sum(categories.values()) / 6) * 15)
            }
        }

        # Output for GitHub Actions
        print(f"::set-output name=total_files::{metrics['file_analysis']['total_files']}")
        print(f"::set-output name=productivity_score::{metrics['productivity_metrics']['enhanced_score']}")
        print(f"::set-output name=roi_percentage::{metrics['financial_impact']['roi_percentage']}")
        print(f"::set-output name=annual_savings::{metrics['financial_impact']['annual_savings_usd']}")

        # Save detailed metrics
        with open('work2027_weekly_metrics.json', 'w') as f:
            json.dump(metrics, f, indent=2)

        print("ğŸ“Š Weekly metrics calculated successfully!")
        print(f"ğŸ“ Total Work 2027 files: {metrics['file_analysis']['total_files']}")
        print(f"ğŸ¯ Productivity score: {metrics['productivity_metrics']['enhanced_score']}")
        print(f"ğŸ’° Annual savings: ${metrics['financial_impact']['annual_savings_usd']:,}")
        print(f"ğŸ“ˆ ROI: {metrics['financial_impact']['roi_percentage']}%")

        EOF

    - name: ğŸ“ˆ Generate Productivity Chart
      run: |
        python << 'EOF'
        import json

        # Load metrics
        with open('work2027_weekly_metrics.json', 'r') as f:
            metrics = json.load(f)

        # Generate ASCII chart for GitHub
        categories = metrics['file_analysis']['categories']
        max_val = max(categories.values()) if categories.values() else 1

        print("ğŸ“Š WORK 2027 COMPONENT DISTRIBUTION")
        print("=" * 40)

        for category, count in categories.items():
            bar_length = int((count / max_val) * 30) if max_val > 0 else 0
            bar = "â–ˆ" * bar_length + "â–‘" * (30 - bar_length)
            print(f"{category.capitalize():15} |{bar}| {count}")

        print("\nğŸ’¡ PRODUCTIVITY IMPACT")
        print("=" * 40)
        prod_metrics = metrics['productivity_metrics']
        print(f"Base productivity:     {prod_metrics['base_score']}")
        print(f"Enhanced productivity: {prod_metrics['enhanced_score']}")
        print(f"Improvement:          +{prod_metrics['improvement_percentage']}%")
        print(f"Multiplier:           {prod_metrics['productivity_multiplier']}x")

        print("\nğŸ’° FINANCIAL IMPACT")
        print("=" * 40)
        fin_metrics = metrics['financial_impact']
        print(f"Annual savings:       ${fin_metrics['annual_savings_usd']:,}")
        print(f"ROI:                  {fin_metrics['roi_percentage']}%")
        print(f"Daily time saved:     {fin_metrics['hours_saved_daily']} hours")

        EOF

    - name: ğŸ“Š Create Issue with Weekly Report
      if: github.event_name == 'schedule'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const metrics = JSON.parse(fs.readFileSync('work2027_weekly_metrics.json', 'utf8'));

          const issueTitle = `ğŸ“Š Work 2027 Weekly Metrics Report - ${new Date().toLocaleDateString()}`;
          const issueBody = `
          # ğŸ“Š Work 2027 Weekly Productivity Report

          ## ğŸ¯ Key Metrics
          - **Total Components**: ${metrics.file_analysis.total_files}
          - **Productivity Score**: ${metrics.productivity_metrics.enhanced_score}/100
          - **ROI**: ${metrics.financial_impact.roi_percentage}%
          - **Annual Savings**: $${metrics.financial_impact.annual_savings_usd.toLocaleString()}

          ## ğŸ“ˆ Productivity Enhancement
          - **Base Score**: ${metrics.productivity_metrics.base_score}
          - **Enhanced Score**: ${metrics.productivity_metrics.enhanced_score}
          - **Improvement**: +${metrics.productivity_metrics.improvement_percentage}%
          - **Multiplier**: ${metrics.productivity_metrics.productivity_multiplier}x

          ## ğŸ“¦ Component Breakdown
          ${Object.entries(metrics.file_analysis.categories).map(([cat, count]) =>
            `- **${cat.charAt(0).toUpperCase() + cat.slice(1)}**: ${count} files`
          ).join('\n')}

          ## ğŸ† Quality Indicators
          - **Documentation**: ${metrics.quality_indicators.documentation_completeness}%
          - **Automation**: ${metrics.quality_indicators.automation_coverage}%
          - **Executive Readiness**: ${metrics.quality_indicators.executive_readiness}%
          - **Overall Maturity**: ${metrics.quality_indicators.overall_maturity}%

          ## ğŸ’° Financial Impact
          - **Hourly Rate**: $${metrics.financial_impact.hourly_rate_usd}
          - **Daily Time Saved**: ${metrics.financial_impact.hours_saved_daily} hours
          - **Working Days**: ${metrics.financial_impact.working_days_annual}/year
          - **Total Annual Value**: $${metrics.financial_impact.annual_savings_usd.toLocaleString()}

          ---
          *Generated automatically by Work 2027 Metrics Dashboard*
          *Timestamp: ${metrics.timestamp}*
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['work2027', 'metrics', 'weekly-report']
          });

    - name: ğŸ“¤ Upload Metrics Artifact
      uses: actions/upload-artifact@v3
      with:
        name: work2027-weekly-metrics-${{ github.run_number }}
        path: work2027_weekly_metrics.json
        retention-days: 365