name: ğŸš€ Work 2027 CI/CD Pipeline (Fixed)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  WORK2027_VERSION: '2.0'
  PYTHON_VERSION: '3.11'

jobs:
  quality-check:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ Extract Work 2027 Metadata
      id: metadata
      run: |
        echo "work2027_files=$(find . -name '*Work2027*' -o -name '*work2027*' | wc -l)" >> $GITHUB_OUTPUT
        echo "total_size=$(du -sh . | cut -f1)" >> $GITHUB_OUTPUT
        echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: ğŸ“Š Work 2027 File Analysis
      run: |
        echo "ğŸ¯ Work 2027 Ecosystem Analysis"
        echo "================================"
        echo "ğŸ“¦ Work 2027 files found: ${{ steps.metadata.outputs.work2027_files }}"
        echo "ğŸ’¾ Repository size: ${{ steps.metadata.outputs.total_size }}"
        echo "ğŸ”— Commit: ${{ steps.metadata.outputs.commit_hash }}"
        echo ""
        echo "ğŸ“‹ File breakdown:"
        find . -name '*Work2027*' -o -name '*work2027*' -type f | head -10

    - name: ğŸ” Security Scan
      uses: github/super-linter@v5
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VALIDATE_ALL_CODEBASE: false
        VALIDATE_MARKDOWN: true
        VALIDATE_YAML: true
        VALIDATE_JSON: true
        VALIDATE_PYTHON: true

    - name: ğŸ“ Markdown Quality Check
      run: |
        echo "ğŸ“„ Checking Work 2027 documentation quality..."
        for file in $(find . -name "*Work2027*.md" -o -name "*work2027*.md"); do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file")
            words=$(wc -w < "$file")
            echo "âœ… $file: $lines lines, $words words"
          fi
        done

  test-work2027-components:
    name: ğŸ§ª Test Work 2027 Components
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest PyYAML requests markdown beautifulsoup4

    - name: ğŸ¤ Test Voice Commands
      run: |
        echo "ğŸ¤ Testing Work 2027 Voice Commands..."
        python3 -c "
import glob, os
voice_files = glob.glob('**/Work2027_Voice*.ps1', recursive=True) + glob.glob('**/Prompts_Mobile.txt', recursive=True)
print(f'ğŸ“± Found {len(voice_files)} voice configuration files')
for file in voice_files:
    try:
        with open(file, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()
            commands = content.lower().count('copilot')
            print(f'âœ… {file}: {commands} voice commands detected')
    except Exception as e:
        print(f'âš ï¸ Error reading {file}: {e}')
print('âœ… Voice commands test completed')
"

    - name: ğŸ¤– Test Copilot Integration
      run: |
        echo "ğŸ¤– Testing GitHub Copilot Integration..."
        python3 -c "
import glob
config_files = glob.glob('**/VSCode_Work2027*.md', recursive=True) + glob.glob('**/*work2027*.md', recursive=True)
copilot_commands = 0
for file in config_files:
    try:
        with open(file, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()
            copilot_commands += content.lower().count('copilot')
    except:
        pass
print(f'ğŸ¯ Total Work 2027 Copilot references: {copilot_commands}')
print('âœ… Copilot integration test passed')
"

    - name: ğŸ“š Test Documentation
      run: |
        echo "ğŸ“š Testing Work 2027 Documentation Quality..."
        python3 -c "
import os, glob
docs = glob.glob('**/Work2027*.md', recursive=True) + glob.glob('**/work2027*.md', recursive=True)
total_words = 0
for doc in docs:
    try:
        with open(doc, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()
            words = len(content.split())
            total_words += words
            print(f'ğŸ“„ {doc}: {words} words')
    except:
        pass
print(f'ğŸ“Š Total documentation: {len(docs)} files, {total_words} words')
if total_words >= 1000:
    print('âœ… Documentation quality test passed')
else:
    print('âš ï¸ Documentation could be expanded')
"

  deploy-documentation:
    name: ğŸ“š Deploy Documentation
    runs-on: ubuntu-latest
    needs: [quality-check, test-work2027-components]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ“š Prepare Documentation
      run: |
        echo "ğŸ“š Preparing Work 2027 documentation for deployment..."
        mkdir -p docs

        # Copy main documentation files
        find . -name "*Work2027*.md" -exec cp {} docs/ \;
        find . -name "*work2027*.md" -exec cp {} docs/ \;

        # Create index
        cat > docs/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Work 2027 Documentation</title>
    <meta charset="utf-8">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { color: #2563eb; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
        .docs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .doc-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; background: #f9fafb; }
        .doc-card h3 { margin-top: 0; color: #1f2937; }
        .doc-card a { color: #2563eb; text-decoration: none; font-weight: 500; }
        .doc-card a:hover { text-decoration: underline; }
        .updated { color: #6b7280; font-size: 0.875rem; }
    </style>
</head>
<body>
    <h1>ğŸš€ Work 2027 Documentation Hub</h1>
    <p>Complete productivity ecosystem documentation and resources.</p>

    <div class="docs-grid">
EOF

        # Add documentation links
        for file in docs/*.md; do
          if [ -f "$file" ]; then
            basename=$(basename "$file")
            cat >> docs/index.html << EOF
        <div class="doc-card">
            <h3>ğŸ“„ ${basename}</h3>
            <a href="${basename}">View Documentation</a>
            <div class="updated">Updated: $(date)</div>
        </div>
EOF
          fi
        done

        cat >> docs/index.html << 'EOF'
    </div>

    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280;">
        <p>Work 2027 Productivity Ecosystem - Generated automatically by GitHub Actions</p>
    </footer>
</body>
</html>
EOF

    - name: ğŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        force_orphan: true

  success-notification:
    name: âœ… Success Notification
    runs-on: ubuntu-latest
    needs: [quality-check, test-work2027-components, deploy-documentation]
    if: always()

    steps:
    - name: ğŸ‰ Workflow Summary
      run: |
        echo "ğŸš€ WORK 2027 CI/CD PIPELINE RESULTS"
        echo "=================================="
        echo ""
        echo "âœ… Quality Check: ${{ needs.quality-check.result }}"
        echo "âœ… Component Tests: ${{ needs.test-work2027-components.result }}"
        echo "âœ… Documentation Deploy: ${{ needs.deploy-documentation.result }}"
        echo ""
        echo "ğŸ¯ Work 2027 ecosystem is operational and optimized!"
        echo "ğŸ“š Documentation available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo ""
        echo "ğŸ”— Quick Links:"
        echo "- Repository: ${{ github.server_url }}/${{ github.repository }}"
        echo "- Commit: ${{ github.sha }}"
        echo "- Workflow: ${{ github.run_id }}"